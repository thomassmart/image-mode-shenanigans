# Bootable Fedora base image
FROM quay.io/fedora/fedora-bootc:latest

# Install nginx + minimal X11 stack + Chromium + lightweight WM
RUN dnf -y install \
      nginx \
      chromium \
      xorg-x11-server-Xorg \
      xorg-x11-xinit \
      xorg-x11-xauth \
      xorg-x11-drv-libinput \
      xset \
      xterm \
      mesa-dri-drivers \
      mesa-libEGL \
      mesa-libGL \
      dbus-x11 \
      curl \
      pciutils \
    && dnf clean all

# OPTIONAL: try to install extra Xorg video drivers if they exist (won't fail build)
RUN dnf -y --setopt=skip_missing_names_on_install=True install \
      xorg-x11-drv-vesa \
      xorg-x11-drv-qxl \
      matchbox-window-manager \
    && dnf clean all || true

# Create a dedicated kiosk user
RUN useradd -m -s /bin/bash kiosk

# Copy website content
COPY index.html /usr/share/nginx/html/index.html

# Enable nginx to start on boot
RUN systemctl enable nginx

# Autologin on tty1 for kiosk user (no manual login required)
RUN mkdir -p /etc/systemd/system/getty@tty1.service.d
COPY config-files/autologin.conf /etc/systemd/system/getty@tty1.service.d/autologin.conf

# Copy kiosk user configuration files
COPY config-files/bash_profile /home/kiosk/.bash_profile
COPY config-files/xinitrc /home/kiosk/.xinitrc

# Set proper permissions
RUN chmod +x /home/kiosk/.xinitrc && \
    chown -R kiosk:kiosk /home/kiosk

EXPOSE 80
