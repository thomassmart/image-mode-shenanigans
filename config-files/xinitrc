#!/usr/bin/env bash
set -e

exec >>/home/kiosk/kiosk-session.log 2>&1

xset s off || true
xset -dpms || true
xset s noblank || true

for i in {1..30}; do
  if curl -fsS http://127.0.0.1/ >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

URL="http://127.0.0.1/"

# Start a very small window manager (helps Chromium map/fullscreen reliably)
# If it's not installed for some reason, we continue anyway.
if command -v matchbox-window-manager >/dev/null 2>&1; then
  matchbox-window-manager -use_titlebar no &
fi

# If Chromium fails, you can switch to a terminal inside X with Alt+F2 in xterm
xterm -geometry 120x40+20+20 -e 'echo "Kiosk debug terminal"; echo "Logs: /home/kiosk/kiosk-session.log"; echo "Press Ctrl+C to close"; bash' &

while true; do
  dbus-run-session chromium-browser \
    --kiosk \
    --user-data-dir=/home/kiosk/.config/chromium-kiosk \
    --enable-logging=stderr \
    --v=1 \
    --no-first-run \
    --disable-translate \
    --disable-infobars \
    --disable-dev-shm-usage \
    --no-sandbox \
    --disable-gpu \
    --disable-gpu-compositing \
    --use-gl=swiftshader \
    --disable-features=Vulkan \
    --check-for-update-interval=31536000 \
    "$URL" || true
  sleep 1
done
