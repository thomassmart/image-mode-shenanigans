<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Self Checkout Demo</title>
<style>
    :root {
        --rainbow-bg: linear-gradient(
            130deg,
            #ff005d 0%,
            #ff7a00 16%,
            #ffd400 32%,
            #2fd36b 48%,
            #1ca9ff 64%,
            #5a54ff 80%,
            #b833ff 100%
        );
        --text-primary: #f7fbff;
        --text-on-accent: #ffffff;
        --panel-soft: rgba(17, 18, 49, 0.56);
        --panel-strong: rgba(8, 13, 38, 0.68);
        --surface: rgba(255, 255, 255, 0.14);
        --surface-alt: rgba(255, 255, 255, 0.08);
        --surface-hover: rgba(255, 255, 255, 0.24);
        --border-soft: rgba(255, 255, 255, 0.26);
        --btn-pay-bg: #ffd400;
        --btn-pay-fg: #332500;
        --btn-pay-hover: #f7c500;
        --btn-alt-bg: #0060ff;
        --btn-alt-hover: #004ed1;
        --btn-cancel-bg: #b833ff;
        --btn-cancel-hover: #9b1fe6;
        --toast-bg: rgba(11, 16, 45, 0.92);
        --modal-backdrop: rgba(7, 9, 25, 0.72);
        --modal-bg: rgba(14, 19, 52, 0.95);
        --shadow: rgba(5, 8, 26, 0.45);
    }

    body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: var(--rainbow-bg);
        background-size: 280% 280%;
        animation: rainbowShift 16s linear infinite;
        color: var(--text-primary);
        display: flex;
        height: 100vh;
    }

    @keyframes rainbowShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .container {
        display: flex;
        width: 100%;
    }

    .items {
        flex: 2;
        background: var(--panel-soft);
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .items h2 {
        margin-top: 0;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: var(--surface-alt);
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        padding: 12px;
        text-align: left;
    }

    th {
        background: var(--panel-strong);
    }

    tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.04);
    }

    .summary {
        flex: 1;
        background: var(--panel-strong);
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .total-box {
        text-align: center;
        margin-top: 20px;
    }

    .total-box h1 {
        font-size: 48px;
        margin: 10px 0;
    }

    .buttons {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        padding: 18px;
        font-size: 18px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }

    .btn-pay {
        background: var(--btn-pay-bg);
        color: var(--btn-pay-fg);
    }

    .btn-pay:hover {
        background: var(--btn-pay-hover);
    }

    .btn-alt {
        background: var(--btn-alt-bg);
        color: var(--text-on-accent);
    }

    .btn-alt:hover {
        background: var(--btn-alt-hover);
    }

    .btn-cancel {
        background: var(--btn-cancel-bg);
        color: var(--text-on-accent);
    }

    .btn-cancel:hover {
        background: var(--btn-cancel-hover);
    }

    .header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .scan-panel {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .camera-panel {
        margin-top: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        background: var(--surface-alt);
        padding: 12px;
    }

    .camera-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .camera-controls label {
        font-size: 14px;
        opacity: 0.95;
    }

    .camera-controls select {
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        background: var(--surface);
        color: var(--text-primary);
        padding: 8px 10px;
        min-width: 220px;
    }

    .camera-status {
        font-size: 13px;
        opacity: 0.9;
    }

    .camera-stage {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-soft);
        box-shadow: 0 8px 20px var(--shadow);
        background: rgba(0, 0, 0, 0.5);
    }

    .camera-stage video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .product-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
        width: 100%;
        margin-top: 10px;
    }

    .btn-product {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--border-soft);
        padding: 14px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
    }

    .btn-product:hover {
        background: var(--surface-hover);
    }

    .btn-scan {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--border-soft);
    }

    .btn-scan:hover {
        background: var(--surface-hover);
    }

    .table-actions {
        width: 1%;
        white-space: nowrap;
        text-align: right;
    }

    .icon-btn {
        background: var(--surface);
        border: 1px solid var(--border-soft);
        color: var(--text-primary);
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }

    .icon-btn:hover {
        background: var(--surface-hover);
    }

    .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--toast-bg);
        border: 1px solid var(--border-soft);
        padding: 12px 14px;
        border-radius: 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s;
        font-size: 14px;
        z-index: 50;
    }

    .toast.show {
        opacity: 1;
    }

    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: var(--modal-backdrop);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }

    .modal {
        width: min(520px, calc(100% - 40px));
        background: var(--modal-bg);
        border: 1px solid var(--border-soft);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 20px 50px var(--shadow);
    }

    .modal h3 {
        margin: 0 0 10px 0;
        font-size: 20px;
    }

    .modal p {
        margin: 8px 0;
        opacity: 0.95;
    }

    .modal .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 14px;
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    .modal .btn {
        padding: 12px 14px;
        font-size: 16px;
        border-radius: 12px;
    }

    .bug-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 18px;
        background: #ff5b00;
        color: #2b0d00;
        z-index: 300;
        text-align: center;
        animation: bugFlash 0.22s steps(1) infinite;
    }

    .bug-face {
        font-size: clamp(120px, 24vw, 360px);
        font-weight: 900;
        line-height: 1;
        letter-spacing: -0.04em;
        text-shadow: 0 8px 0 rgba(0, 0, 0, 0.18);
    }

    .bug-title {
        font-size: clamp(28px, 3.8vw, 64px);
        font-weight: 900;
        letter-spacing: 0.06em;
    }

    .bug-subtitle {
        font-size: clamp(16px, 2vw, 28px);
        font-weight: 700;
        padding: 0 20px;
    }

    .screensaver-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: #000;
        z-index: 500;
    }

    .screensaver-overlay video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    @keyframes bugFlash {
        0% { background: #ff7a00; }
        50% { background: #ff5b00; }
        100% { background: #ff3d00; }
    }

    .footer {
        margin-top: 18px;
    }

    .footer-text {
        opacity: 0.9;
        line-height: 1.35;
        font-size: 14px;
    }

</style>
</head>
<body>
<div class="container">

    <div class="items">
        <div class="header">Scan Items</div>

        <div class="scan-panel" aria-label="Scan panel">
            <div class="product-buttons">
                <button class="btn-product" data-key="apples">Organic Apples</button>
                <button class="btn-product" data-key="bananas">Bananas</button>
                <button class="btn-product" data-key="milk">Milk 2L</button>
                <button class="btn-product" data-key="eggs">Free Range Eggs (12)</button>
                <button class="btn-product" data-key="bread">Fresh Bread</button>
                <button class="btn-product" data-key="choc">Chocolate Bar</button>
                <button class="btn-product" data-key="coffee">Ground Coffee 250g</button>
                <button class="btn-product" data-key="chips">Potato Chips</button>
                <button class="btn-product" data-key="cheese">Tasty Cheese 500g</button>
                <button class="btn-product" data-key="berries">Mixed Berries 300g</button>
                <button class="btn-product" data-key="yogurt">Greek Yogurt 1kg</button>
                <button class="btn-product" data-key="chicken">Chicken Breast 1kg</button>
            </div>
        </div>

        <div class="camera-panel" aria-label="Camera preview panel">
            <div class="camera-controls">
                <label for="cameraSelect">Camera</label>
                <select id="cameraSelect" aria-label="Camera device selection">
                    <option value="">Loading cameras…</option>
                </select>
                <div id="cameraStatus" class="camera-status">Initializing camera preview…</div>
            </div>
            <div class="camera-stage">
                <video id="cameraPreview" autoplay muted playsinline></video>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th class="table-actions">Actions</th>
                </tr>
            </thead>
            <tbody id="cartBody"></tbody>
        </table>
    </div>

    <div class="summary">
        <div>
            <div class="header">Total</div>
            <div class="total-box">
                <h1 id="totalAmount">$0.00</h1>
                <p><span id="itemCount">0</span> items</p>
            </div>

            <div class="buttons">
                <button id="payNowBtn" class="btn btn-pay" type="button">Pay Now</button>
                <button id="cardBtn" class="btn btn-alt" type="button">Card Payment</button>
                <button id="walletBtn" class="btn btn-alt" type="button">Mobile Wallet</button>
                <button id="cancelBtn" class="btn btn-cancel" type="button">Cancel Transaction</button>
            </div>
        </div>

        <div class="footer">
            <div class="footer-text">
                Touch screen to continue<br>
                Demo Self-Checkout Interface
            </div>
        </div>
    </div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
        <h3 id="modalTitle">Payment</h3>
        <p id="modalBody">…</p>
        <div class="modal-actions">
            <button id="modalClose" class="btn btn-alt" type="button">Close</button>
            <button id="modalPrimary" class="btn btn-pay" type="button">Confirm</button>
        </div>
    </div>
</div>

<div id="bugOverlay" class="bug-overlay" role="alert" aria-live="assertive" aria-hidden="true">
    <div class="bug-face">:-(</div>
    <div class="bug-title">CRITICAL CHECKOUT ERROR</div>
    <div class="bug-subtitle">A serious issue has occurred.</div>
</div>

<div id="screensaverOverlay" class="screensaver-overlay" aria-hidden="true">
    <video id="screensaverVideo" loop muted playsinline preload="metadata">
        <source src="/screensaver.mp4" type="video/mp4">
    </video>
</div>

<script>
(() => {
    const IDLE_TIMEOUT_MS = 45000;
    const products = {
        apples: { name: 'Organic Apples', price: 3.20 },
        milk: { name: 'Milk 2L', price: 2.80 },
        choc: { name: 'Chocolate Bar', price: 2.00 }, // per bar
        bread: { name: 'Fresh Bread', price: 3.50 },
        bananas: { name: 'Bananas', price: 1.30 },
        eggs: { name: 'Free Range Eggs (12)', price: 6.40 },
        coffee: { name: 'Ground Coffee 250g', price: 7.90 },
        chips: { name: 'Potato Chips', price: 3.10 },
        cheese: { name: 'Tasty Cheese 500g', price: 8.50 },
        berries: { name: 'Mixed Berries 300g', price: 6.90 },
        yogurt: { name: 'Greek Yogurt 1kg', price: 7.20 },
        chicken: { name: 'Chicken Breast 1kg', price: 12.90 }
    };

    /** @type {Map<string, {key:string, name:string, price:number, qty:number}>} */
    const cart = new Map();

    const $ = (id) => document.getElementById(id);

    const cartBody = $('cartBody');
    const totalAmountEl = $('totalAmount');
    const itemCountEl = $('itemCount');


    const payNowBtn = $('payNowBtn');
    const cardBtn = $('cardBtn');
    const walletBtn = $('walletBtn');
    const cancelBtn = $('cancelBtn');

    const toast = $('toast');

    const modalBackdrop = $('modalBackdrop');
    const modalTitle = $('modalTitle');
    const modalBody = $('modalBody');
    const modalClose = $('modalClose');
    const modalPrimary = $('modalPrimary');
    const bugOverlay = $('bugOverlay');
    const cameraPreview = $('cameraPreview');
    const cameraSelect = $('cameraSelect');
    const cameraStatus = $('cameraStatus');
    const screensaverOverlay = $('screensaverOverlay');
    const screensaverVideo = $('screensaverVideo');

    let modalPrimaryHandler = null;
    let fakeBugTriggered = false;
    let activeCameraStream = null;
    let screensaverTimer = null;
    let screensaverActive = false;

    // AUD display while keeping formatting consistent (but no currency symbol surprises for demo)
    function moneyAUD(n) {
        return '$' + n.toFixed(2);
    }

    function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add('show');
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(() => toast.classList.remove('show'), 1600);
    }

    function computeTotals() {
        let total = 0;
        let items = 0;
        for (const line of cart.values()) {
            total += line.price * line.qty;
            items += line.qty;
        }
        return { total, items };
    }

    function openModal(title, body, primaryText, onPrimary) {
        modalTitle.textContent = title;
        modalBody.textContent = body;
        modalPrimary.textContent = primaryText || 'OK';
        modalPrimary.style.display = onPrimary ? 'inline-block' : 'none';

        if (modalPrimaryHandler) {
            modalPrimary.removeEventListener('click', modalPrimaryHandler);
            modalPrimaryHandler = null;
        }
        if (onPrimary) {
            modalPrimaryHandler = () => onPrimary();
            modalPrimary.addEventListener('click', modalPrimaryHandler);
        }

        modalBackdrop.style.display = 'flex';
        modalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function closeModal() {
        modalBackdrop.style.display = 'none';
        modalBackdrop.setAttribute('aria-hidden', 'true');
        if (modalPrimaryHandler) {
            modalPrimary.removeEventListener('click', modalPrimaryHandler);
            modalPrimaryHandler = null;
        }
    }

    function stopCameraStream() {
        if (!activeCameraStream) return;
        activeCameraStream.getTracks().forEach(track => track.stop());
        activeCameraStream = null;
    }

    async function refreshCameraDevices(selectedId) {
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
            cameraSelect.innerHTML = '<option value="">No camera API available</option>';
            return;
        }

        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(device => device.kind === 'videoinput');
        cameraSelect.innerHTML = '';

        if (cameras.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No cameras found';
            cameraSelect.appendChild(opt);
            cameraSelect.disabled = true;
            return;
        }

        cameraSelect.disabled = false;
        cameras.forEach((camera, idx) => {
            const opt = document.createElement('option');
            opt.value = camera.deviceId;
            opt.textContent = camera.label || `Camera ${idx + 1}`;
            cameraSelect.appendChild(opt);
        });

        if (selectedId) {
            cameraSelect.value = selectedId;
        }
    }

    async function startCamera(deviceId) {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            cameraStatus.textContent = 'Camera preview is unavailable in this browser.';
            return;
        }

        stopCameraStream();
        cameraStatus.textContent = 'Starting camera...';

        const constraints = {
            video: deviceId ? { deviceId: { exact: deviceId } } : true,
            audio: false
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            activeCameraStream = stream;
            cameraPreview.srcObject = stream;

            const currentTrack = stream.getVideoTracks()[0];
            const currentDeviceId = currentTrack ? currentTrack.getSettings().deviceId : '';
            await refreshCameraDevices(currentDeviceId || deviceId || '');
            cameraStatus.textContent = 'Live camera preview active.';
        } catch (err) {
            cameraStatus.textContent = `Camera unavailable: ${err.message || 'unknown error'}`;
            cameraSelect.innerHTML = '<option value="">Camera unavailable</option>';
            cameraSelect.disabled = true;
        }
    }

    function renderCart() {
        cartBody.innerHTML = '';

        for (const line of cart.values()) {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = line.name;

            const tdQty = document.createElement('td');
            tdQty.textContent = String(line.qty);

            const tdPrice = document.createElement('td');
            tdPrice.textContent = moneyAUD(line.price * line.qty);

            const tdActions = document.createElement('td');
            tdActions.className = 'table-actions';

            const minusBtn = document.createElement('button');
            minusBtn.className = 'icon-btn';
            minusBtn.type = 'button';
            minusBtn.textContent = '−';
            minusBtn.title = 'Decrease quantity';
            minusBtn.addEventListener('click', () => adjustQty(line.key, -1));

            const plusBtn = document.createElement('button');
            plusBtn.className = 'icon-btn';
            plusBtn.type = 'button';
            plusBtn.textContent = '+';
            plusBtn.title = 'Increase quantity';
            plusBtn.style.marginLeft = '8px';
            plusBtn.addEventListener('click', () => adjustQty(line.key, +1));

            const removeBtn = document.createElement('button');
            removeBtn.className = 'icon-btn';
            removeBtn.type = 'button';
            removeBtn.textContent = 'Remove';
            removeBtn.title = 'Remove item';
            removeBtn.style.marginLeft = '8px';
            removeBtn.addEventListener('click', () => removeLine(line.key));

            tdActions.appendChild(minusBtn);
            tdActions.appendChild(plusBtn);
            tdActions.appendChild(removeBtn);

            tr.appendChild(tdName);
            tr.appendChild(tdQty);
            tr.appendChild(tdPrice);
            tr.appendChild(tdActions);

            cartBody.appendChild(tr);
        }

        const { total, items } = computeTotals();
        totalAmountEl.textContent = moneyAUD(total);
        itemCountEl.textContent = String(items);

        // Disable pay buttons when empty
        const disabled = cart.size === 0;
        payNowBtn.disabled = disabled;
        cardBtn.disabled = disabled;
        walletBtn.disabled = disabled;
        payNowBtn.style.opacity = disabled ? '0.6' : '1';
        cardBtn.style.opacity = disabled ? '0.6' : '1';
        walletBtn.style.opacity = disabled ? '0.6' : '1';

        // Keep cancel enabled (it just clears)
    }

    function addToCart(key, qty) {
        const p = products[key];
        if (!p) return;
        const existing = cart.get(key);
        if (existing) {
            existing.qty += qty;
        } else {
            cart.set(key, { key, name: p.name, price: p.price, qty });
        }
        showToast(`Scanned: ${p.name} x${qty}`);
        renderCart();

        const { items } = computeTotals();
        if (!fakeBugTriggered && items === 2) {
            triggerFakeBug();
        }
    }

    function adjustQty(key, delta) {
        const line = cart.get(key);
        if (!line) return;
        line.qty += delta;
        if (line.qty <= 0) {
            cart.delete(key);
            showToast('Item removed');
        } else {
            showToast('Quantity updated');
        }
        renderCart();
    }

    function removeLine(key) {
        if (cart.has(key)) {
            cart.delete(key);
            showToast('Item removed');
            renderCart();
        }
    }

    function clearCart() {
        cart.clear();
        renderCart();
    }

    function triggerFakeBug() {
        fakeBugTriggered = true;
        bugOverlay.style.display = 'flex';
        bugOverlay.setAttribute('aria-hidden', 'false');
    }

    function showScreensaver() {
        if (screensaverActive) return;
        screensaverActive = true;
        screensaverOverlay.style.display = 'flex';
        screensaverOverlay.setAttribute('aria-hidden', 'false');
        screensaverVideo.play().catch(() => {});
    }

    function hideScreensaver() {
        if (!screensaverActive) return;
        screensaverActive = false;
        screensaverOverlay.style.display = 'none';
        screensaverOverlay.setAttribute('aria-hidden', 'true');
        screensaverVideo.pause();
        screensaverVideo.currentTime = 0;
    }

    function scheduleScreensaver() {
        window.clearTimeout(screensaverTimer);
        screensaverTimer = window.setTimeout(showScreensaver, IDLE_TIMEOUT_MS);
    }

    function handleUserActivity() {
        if (screensaverActive) {
            hideScreensaver();
        }
        scheduleScreensaver();
    }


    function payFlow(methodLabel) {
        const { total, items } = computeTotals();
        if (items === 0) {
            showToast('Scan something first');
            return;
        }

        openModal(
            `${methodLabel}`,
            `You are about to pay ${moneyAUD(total)} for ${items} item(s).`,
            'Confirm payment',
            () => {
                closeModal();
                showToast('Payment approved (demo)');
                // Simulate receipt by clearing cart
                clearCart();
            }
        );
    }

    // Wire up events
    const productButtons = document.querySelectorAll('.btn-product');

    productButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-key');
            addToCart(key, 1);
        });
    });


    payNowBtn.addEventListener('click', () => payFlow('Pay Now'));
    cardBtn.addEventListener('click', () => payFlow('Card Payment'));
    walletBtn.addEventListener('click', () => payFlow('Mobile Wallet'));

    cancelBtn.addEventListener('click', () => {
        if (cart.size === 0) {
            showToast('Nothing to cancel');
            return;
        }
        openModal('Cancel transaction', 'This will cancel the transaction and clear the cart.', 'Cancel transaction', () => {
            closeModal();
            clearCart();
            showToast('Transaction cancelled');
        });
    });

    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        handleUserActivity();
        if (e.key === 'Escape') closeModal();
    });
    cameraSelect.addEventListener('change', () => startCamera(cameraSelect.value));

    const activityEvents = ['mousemove', 'mousedown', 'touchstart', 'wheel'];
    activityEvents.forEach(eventName => {
        document.addEventListener(eventName, handleUserActivity, { passive: true });
    });
    screensaverOverlay.addEventListener('click', handleUserActivity);
    screensaverOverlay.addEventListener('mousemove', handleUserActivity);

    // Initial state
    renderCart();
    startCamera('');
    scheduleScreensaver();
})();
</script>
</body>
</html>
