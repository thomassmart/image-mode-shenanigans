<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Self Checkout Demo</title>
<style>
    html, body {
        height: 100%;
        overflow: hidden;
    }

    :root {
        --rainbow-bg: linear-gradient(
            130deg,
            #e9ffe9 0%,
            #c6f7cf 24%,
            #6cc17e 48%,
            #2e7d4a 72%,
            #0f3a24 100%
        );
        --text-primary: #ecfff2;
        --text-on-accent: #ffffff;
        --panel-soft: rgba(14, 63, 36, 0.58);
        --panel-strong: rgba(8, 44, 25, 0.72);
        --surface: rgba(209, 255, 220, 0.18);
        --surface-alt: rgba(214, 255, 222, 0.12);
        --surface-hover: rgba(225, 255, 231, 0.28);
        --border-soft: rgba(214, 255, 223, 0.32);
        --btn-pay-bg: #b8f27e;
        --btn-pay-fg: #143319;
        --btn-pay-hover: #a9e36f;
        --btn-alt-bg: #2f8f5a;
        --btn-alt-hover: #257648;
        --btn-cancel-bg: #1f5f3a;
        --btn-cancel-hover: #17482b;
        --toast-bg: rgba(8, 39, 22, 0.94);
        --modal-backdrop: rgba(5, 30, 16, 0.76);
        --modal-bg: rgba(10, 54, 30, 0.95);
        --shadow: rgba(3, 24, 12, 0.42);
    }

    body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: var(--rainbow-bg);
        background-size: 280% 280%;
        animation: rainbowShift 16s linear infinite;
        color: var(--text-primary);
        display: flex;
        min-height: 100vh;
    }

    @keyframes rainbowShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .container {
        display: flex;
        width: 100%;
        min-height: 100vh;
        overflow: hidden;
    }

    .build-badge {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 200;
        padding: 6px 10px;
        border: 1px solid var(--border-soft);
        border-radius: 999px;
        background: rgba(10, 54, 30, 0.82);
        color: var(--text-primary);
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.03em;
        backdrop-filter: blur(6px);
    }

    .items {
        flex: 2;
        background: var(--panel-soft);
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .items h2 {
        margin-top: 0;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: var(--surface-alt);
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        padding: 12px;
        text-align: left;
    }

    th {
        background: var(--panel-strong);
    }

    tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.04);
    }

    .summary {
        flex: 1;
        background: var(--panel-strong);
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .total-box {
        text-align: center;
        margin-top: 20px;
    }

    .total-box h1 {
        font-size: 48px;
        margin: 10px 0;
    }

    .buttons {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        padding: 18px;
        font-size: 18px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }

    .btn-pay {
        background: var(--btn-pay-bg);
        color: var(--btn-pay-fg);
    }

    .btn-pay:hover {
        background: var(--btn-pay-hover);
    }

    .btn-alt {
        background: var(--btn-alt-bg);
        color: var(--text-on-accent);
    }

    .btn-alt:hover {
        background: var(--btn-alt-hover);
    }

    .btn-cancel {
        background: var(--btn-cancel-bg);
        color: var(--text-on-accent);
    }

    .btn-cancel:hover {
        background: var(--btn-cancel-hover);
    }

    .header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .scan-panel {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .pos-status {
        margin-top: 6px;
        font-size: 13px;
        opacity: 0.9;
    }

    .camera-panel {
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        background: var(--surface-alt);
        padding: 12px;
        box-sizing: border-box;
    }

    .camera-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .camera-controls label {
        font-size: 14px;
        opacity: 0.95;
    }

    .camera-controls select {
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        background: var(--surface);
        color: var(--text-primary);
        padding: 8px 10px;
        min-width: 220px;
    }

    .camera-status {
        font-size: 13px;
        opacity: 0.9;
    }

    .camera-stage {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-soft);
        box-shadow: 0 8px 20px var(--shadow);
        background: rgba(0, 0, 0, 0.5);
    }

    .camera-stage video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .product-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
        width: 100%;
        margin-top: 10px;
    }

    .btn-product {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--border-soft);
        padding: 14px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
    }

    .btn-product:hover {
        background: var(--surface-hover);
    }

    .btn-scan {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--border-soft);
    }

    .btn-scan:hover {
        background: var(--surface-hover);
    }

    .table-actions {
        width: 1%;
        white-space: nowrap;
        text-align: right;
    }

    .icon-btn {
        background: var(--surface);
        border: 1px solid var(--border-soft);
        color: var(--text-primary);
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }

    .icon-btn:hover {
        background: var(--surface-hover);
    }

    .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--toast-bg);
        border: 1px solid var(--border-soft);
        padding: 12px 14px;
        border-radius: 12px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s;
        font-size: 14px;
        z-index: 50;
    }

    .toast.show {
        opacity: 1;
    }

    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: var(--modal-backdrop);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }

    .modal {
        width: min(520px, calc(100% - 40px));
        background: var(--modal-bg);
        border: 1px solid var(--border-soft);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 20px 50px var(--shadow);
    }

    .modal h3 {
        margin: 0 0 10px 0;
        font-size: 20px;
    }

    .modal p {
        margin: 8px 0;
        opacity: 0.95;
    }

    .modal .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 14px;
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    .modal .btn {
        padding: 12px 14px;
        font-size: 16px;
        border-radius: 12px;
    }

    .bug-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 18px;
        background: #ff5b00;
        color: #2b0d00;
        z-index: 300;
        text-align: center;
        animation: bugFlash 0.22s steps(1) infinite;
    }

    .bug-face {
        font-size: clamp(120px, 24vw, 360px);
        font-weight: 900;
        line-height: 1;
        letter-spacing: -0.04em;
        text-shadow: 0 8px 0 rgba(0, 0, 0, 0.18);
    }

    .bug-title {
        font-size: clamp(28px, 3.8vw, 64px);
        font-weight: 900;
        letter-spacing: 0.06em;
    }

    .bug-subtitle {
        font-size: clamp(16px, 2vw, 28px);
        font-weight: 700;
        padding: 0 20px;
    }

    .screensaver-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: #000;
        z-index: 500;
    }

    .screensaver-overlay video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .screensaver-message {
        position: absolute;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 14px;
        border: 1px solid var(--border-soft);
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #f4f6ff;
        font-size: 14px;
        z-index: 1;
        display: none;
    }

    @keyframes bugFlash {
        0% { background: #ff7a00; }
        50% { background: #ff5b00; }
        100% { background: #ff3d00; }
    }

    .footer {
        margin-top: 18px;
        width: 100%;
    }

    .summary .camera-panel {
        width: 100%;
        margin: 0;
        flex-shrink: 0;
    }

    @media (max-width: 960px) {
        .summary .camera-panel {
            width: 100%;
        }
    }

</style>
</head>
<body>
<div class="build-badge" aria-label="Build version">__BUILD_VERSION__</div>
<div class="container">

    <div class="items">
        <div class="header">Scan Items</div>
        <div id="posStatus" class="pos-status">POS bridge: connecting…</div>

        <div class="scan-panel" aria-label="Scan panel">
            <div class="product-buttons">
                <button class="btn-product" data-key="apples">Organic Apples</button>
                <button class="btn-product" data-key="bananas">Bananas</button>
                <button class="btn-product" data-key="milk">Milk 2L</button>
                <button class="btn-product" data-key="eggs">Free Range Eggs (12)</button>
                <button class="btn-product" data-key="bread">Fresh Bread</button>
                <button class="btn-product" data-key="choc">Chocolate Bar</button>
                <button class="btn-product" data-key="coffee">Ground Coffee 250g</button>
                <button class="btn-product" data-key="chips">Potato Chips</button>
                <button class="btn-product" data-key="cheese">Tasty Cheese 500g</button>
                <button class="btn-product" data-key="berries">Mixed Berries 300g</button>
                <button class="btn-product" data-key="yogurt">Greek Yogurt 1kg</button>
                <button class="btn-product" data-key="chicken">Chicken Breast 1kg</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th class="table-actions">Actions</th>
                </tr>
            </thead>
            <tbody id="cartBody"></tbody>
        </table>
    </div>

    <div class="summary">
        <div>
            <div class="header">Total</div>
            <div class="total-box">
                <h1 id="totalAmount">$0.00</h1>
                <p><span id="itemCount">0</span> items</p>
            </div>

            <div class="buttons">
                <button id="payNowBtn" class="btn btn-pay" type="button">Pay Now</button>
                <button id="cardBtn" class="btn btn-alt" type="button">Card Payment</button>
                <button id="walletBtn" class="btn btn-alt" type="button">Mobile Wallet</button>
                <button id="cancelBtn" class="btn btn-cancel" type="button">Cancel Transaction</button>
            </div>
        </div>

        <div class="footer">
            <div class="camera-panel" aria-label="Camera preview panel">
                <div class="camera-controls">
                    <label for="cameraSelect">Camera</label>
                    <select id="cameraSelect" aria-label="Camera device selection">
                        <option value="">Loading cameras…</option>
                    </select>
                    <div id="cameraStatus" class="camera-status">Initializing camera preview…</div>
                </div>
                <div class="camera-stage">
                    <video id="cameraPreview" autoplay muted playsinline></video>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
        <h3 id="modalTitle">Payment</h3>
        <p id="modalBody">…</p>
        <div class="modal-actions">
            <button id="modalClose" class="btn btn-alt" type="button">Close</button>
            <button id="modalPrimary" class="btn btn-pay" type="button">Confirm</button>
        </div>
    </div>
</div>

<div id="bugOverlay" class="bug-overlay" role="alert" aria-live="assertive" aria-hidden="true">
    <div class="bug-face">:-(</div>
    <div class="bug-title">CRITICAL CHECKOUT ERROR</div>
    <div class="bug-subtitle">A serious issue has occurred.</div>
</div>

<div id="screensaverOverlay" class="screensaver-overlay" aria-hidden="true">
    <video id="screensaverVideo" loop autoplay muted playsinline preload="auto">
        <source src="screensaver.mp4" type="video/mp4">
        <source src="./screensaver.mp4" type="video/mp4">
        <source src="file:///usr/share/kiosk-site/screensaver.mp4" type="video/mp4">
    </video>
    <div id="screensaverMessage" class="screensaver-message">Screensaver active - touch to continue</div>
</div>

<script>
(() => {
    const IDLE_TIMEOUT_MS = 60000;
    const ENABLE_FAKE_BUG = true;
    const products = {
        apples: { name: 'Organic Apples', price: 3.20 },
        milk: { name: 'Milk 2L', price: 2.80 },
        choc: { name: 'Chocolate Bar', price: 2.00 }, // per bar
        bread: { name: 'Fresh Bread', price: 3.50 },
        bananas: { name: 'Bananas', price: 1.30 },
        eggs: { name: 'Free Range Eggs (12)', price: 6.40 },
        coffee: { name: 'Ground Coffee 250g', price: 7.90 },
        chips: { name: 'Potato Chips', price: 3.10 },
        cheese: { name: 'Tasty Cheese 500g', price: 8.50 },
        berries: { name: 'Mixed Berries 300g', price: 6.90 },
        yogurt: { name: 'Greek Yogurt 1kg', price: 7.20 },
        chicken: { name: 'Chicken Breast 1kg', price: 12.90 }
    };

    /** @type {Map<string, {key:string, name:string, price:number, qty:number}>} */
    const cart = new Map();

    const $ = (id) => document.getElementById(id);

    const cartBody = $('cartBody');
    const totalAmountEl = $('totalAmount');
    const itemCountEl = $('itemCount');


    const payNowBtn = $('payNowBtn');
    const cardBtn = $('cardBtn');
    const walletBtn = $('walletBtn');
    const cancelBtn = $('cancelBtn');

    const toast = $('toast');

    const modalBackdrop = $('modalBackdrop');
    const modalTitle = $('modalTitle');
    const modalBody = $('modalBody');
    const modalClose = $('modalClose');
    const modalPrimary = $('modalPrimary');
    const bugOverlay = $('bugOverlay');
    const cameraPreview = $('cameraPreview');
    const cameraSelect = $('cameraSelect');
    const cameraStatus = $('cameraStatus');
    const posStatus = $('posStatus');
    const screensaverOverlay = $('screensaverOverlay');
    const screensaverVideo = $('screensaverVideo');
    const screensaverMessage = $('screensaverMessage');

    let modalPrimaryHandler = null;
    let fakeBugTriggered = false;
    let activeCameraStream = null;
    let screensaverTimer = null;
    let screensaverActive = false;
    let screensaverKeepaliveTimer = null;
    let posEvents = null;
    let posReconnectTimer = null;
    const transactionBarcodePrices = new Map();
    let keyboardScanBuffer = '';
    let keyboardScanTimer = null;

    // AUD display while keeping formatting consistent (but no currency symbol surprises for demo)
    function moneyAUD(n) {
        return '$' + n.toFixed(2);
    }

    function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add('show');
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(() => toast.classList.remove('show'), 1600);
    }

    function randomPrice() {
        return Number((Math.random() * 24 + 1).toFixed(2));
    }

    function resetTransactionPricing() {
        transactionBarcodePrices.clear();
    }

    function upsertBarcodeProduct(barcode) {
        const known = transactionBarcodePrices.get(barcode);
        if (known) return known;

        const key = `scan:${barcode}`;
        const price = randomPrice();
        const name = `Scanned Barcode ${barcode}`;
        transactionBarcodePrices.set(barcode, { key, name, price });
        products[key] = { name, price };
        return { key, name, price };
    }

    function sanitizeBarcode(raw) {
        const cleaned = String(raw || '').trim();
        if (!cleaned) return '';
        return cleaned.replace(/[^0-9A-Za-z_-]/g, '');
    }

    function handleBarcodeScan(rawBarcode) {
        const barcode = sanitizeBarcode(rawBarcode);
        if (barcode.length < 4) return;
        const p = upsertBarcodeProduct(barcode);
        addToCart(p.key, 1);
    }

    function handleKeyboardScannerKey(e) {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

        if (e.key === 'Enter' || e.key === 'Tab') {
            if (keyboardScanBuffer.length >= 4) {
                handleBarcodeScan(keyboardScanBuffer);
            }
            keyboardScanBuffer = '';
            window.clearTimeout(keyboardScanTimer);
            return;
        }

        if (e.key.length === 1) {
            keyboardScanBuffer += e.key;
            window.clearTimeout(keyboardScanTimer);
            keyboardScanTimer = window.setTimeout(() => {
                // Some scanners don't send Enter/Tab suffix; commit on short idle.
                if (keyboardScanBuffer.length >= 4) {
                    handleBarcodeScan(keyboardScanBuffer);
                }
                keyboardScanBuffer = '';
            }, 180);
        }
    }

    async function postReceipt(methodLabel) {
        const { total } = computeTotals();
        const items = Array.from(cart.values()).map((line) => ({
            name: line.name,
            qty: line.qty,
            unit_price: line.price,
            line_total: Number((line.price * line.qty).toFixed(2))
        }));

        const payload = {
            transaction_id: `txn-${Date.now()}`,
            payment_method: methodLabel,
            timestamp: new Date().toISOString(),
            items,
            total: Number(total.toFixed(2))
        };

        const resp = await fetch('http://127.0.0.1:8091/print', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!resp.ok) {
            let msg = 'print failed';
            try {
                const body = await resp.json();
                if (body && body.error) msg = body.error;
            } catch (_) {}
            throw new Error(msg);
        }
    }

    function schedulePosReconnect() {
        window.clearTimeout(posReconnectTimer);
        posReconnectTimer = window.setTimeout(connectPosEvents, 3000);
    }

    function connectPosEvents() {
        if (!window.EventSource) {
            posStatus.textContent = 'POS bridge: EventSource unavailable';
            return;
        }

        if (posEvents) {
            posEvents.close();
            posEvents = null;
        }

        posStatus.textContent = 'POS bridge: connecting...';
        posEvents = new EventSource('http://127.0.0.1:8091/events');

        posEvents.addEventListener('open', () => {
            posStatus.textContent = 'POS bridge: connected';
        });

        posEvents.addEventListener('scan', (event) => {
            handleUserActivity();
            try {
                const payload = JSON.parse(event.data);
                handleBarcodeScan(payload.barcode);
            } catch (_) {
                // Ignore malformed event payloads.
            }
        });

        posEvents.addEventListener('error', () => {
            posStatus.textContent = 'POS bridge: reconnecting...';
            if (posEvents) {
                posEvents.close();
                posEvents = null;
            }
            schedulePosReconnect();
        });
    }

    function computeTotals() {
        let total = 0;
        let items = 0;
        for (const line of cart.values()) {
            total += line.price * line.qty;
            items += line.qty;
        }
        return { total, items };
    }

    function openModal(title, body, primaryText, onPrimary) {
        modalTitle.textContent = title;
        modalBody.textContent = body;
        modalPrimary.textContent = primaryText || 'OK';
        modalPrimary.style.display = onPrimary ? 'inline-block' : 'none';

        if (modalPrimaryHandler) {
            modalPrimary.removeEventListener('click', modalPrimaryHandler);
            modalPrimaryHandler = null;
        }
        if (onPrimary) {
            modalPrimaryHandler = () => onPrimary();
            modalPrimary.addEventListener('click', modalPrimaryHandler);
        }

        modalBackdrop.style.display = 'flex';
        modalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function closeModal() {
        modalBackdrop.style.display = 'none';
        modalBackdrop.setAttribute('aria-hidden', 'true');
        if (modalPrimaryHandler) {
            modalPrimary.removeEventListener('click', modalPrimaryHandler);
            modalPrimaryHandler = null;
        }
    }

    function stopCameraStream() {
        if (!activeCameraStream) return;
        activeCameraStream.getTracks().forEach(track => track.stop());
        activeCameraStream = null;
    }

    async function refreshCameraDevices(selectedId) {
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
            cameraSelect.innerHTML = '<option value="">No camera API available</option>';
            return;
        }

        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(device => device.kind === 'videoinput');
        cameraSelect.innerHTML = '';

        if (cameras.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No cameras found';
            cameraSelect.appendChild(opt);
            cameraSelect.disabled = true;
            return;
        }

        cameraSelect.disabled = false;
        cameras.forEach((camera, idx) => {
            const opt = document.createElement('option');
            opt.value = camera.deviceId;
            opt.textContent = camera.label || `Camera ${idx + 1}`;
            cameraSelect.appendChild(opt);
        });

        if (selectedId) {
            cameraSelect.value = selectedId;
        }
    }

    async function startCamera(deviceId) {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            cameraStatus.textContent = 'Camera preview is unavailable in this browser.';
            return;
        }

        stopCameraStream();
        cameraStatus.textContent = 'Starting camera...';

        const constraints = {
            video: deviceId ? { deviceId: { exact: deviceId } } : true,
            audio: false
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            activeCameraStream = stream;
            cameraPreview.srcObject = stream;

            const currentTrack = stream.getVideoTracks()[0];
            const currentDeviceId = currentTrack ? currentTrack.getSettings().deviceId : '';
            await refreshCameraDevices(currentDeviceId || deviceId || '');
            cameraStatus.textContent = 'Live camera preview active.';
        } catch (err) {
            cameraStatus.textContent = `Camera unavailable: ${err.message || 'unknown error'}`;
            cameraSelect.innerHTML = '<option value="">Camera unavailable</option>';
            cameraSelect.disabled = true;
        }
    }

    function renderCart() {
        cartBody.innerHTML = '';

        for (const line of cart.values()) {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = line.name;

            const tdQty = document.createElement('td');
            tdQty.textContent = String(line.qty);

            const tdPrice = document.createElement('td');
            tdPrice.textContent = moneyAUD(line.price * line.qty);

            const tdActions = document.createElement('td');
            tdActions.className = 'table-actions';

            const minusBtn = document.createElement('button');
            minusBtn.className = 'icon-btn';
            minusBtn.type = 'button';
            minusBtn.textContent = '−';
            minusBtn.title = 'Decrease quantity';
            minusBtn.addEventListener('click', () => adjustQty(line.key, -1));

            const plusBtn = document.createElement('button');
            plusBtn.className = 'icon-btn';
            plusBtn.type = 'button';
            plusBtn.textContent = '+';
            plusBtn.title = 'Increase quantity';
            plusBtn.style.marginLeft = '8px';
            plusBtn.addEventListener('click', () => adjustQty(line.key, +1));

            const removeBtn = document.createElement('button');
            removeBtn.className = 'icon-btn';
            removeBtn.type = 'button';
            removeBtn.textContent = 'Remove';
            removeBtn.title = 'Remove item';
            removeBtn.style.marginLeft = '8px';
            removeBtn.addEventListener('click', () => removeLine(line.key));

            tdActions.appendChild(minusBtn);
            tdActions.appendChild(plusBtn);
            tdActions.appendChild(removeBtn);

            tr.appendChild(tdName);
            tr.appendChild(tdQty);
            tr.appendChild(tdPrice);
            tr.appendChild(tdActions);

            cartBody.appendChild(tr);
        }

        const { total, items } = computeTotals();
        totalAmountEl.textContent = moneyAUD(total);
        itemCountEl.textContent = String(items);

        // Disable pay buttons when empty
        const disabled = cart.size === 0;
        payNowBtn.disabled = disabled;
        cardBtn.disabled = disabled;
        walletBtn.disabled = disabled;
        payNowBtn.style.opacity = disabled ? '0.6' : '1';
        cardBtn.style.opacity = disabled ? '0.6' : '1';
        walletBtn.style.opacity = disabled ? '0.6' : '1';

        // Keep cancel enabled (it just clears)
    }

    function addToCart(key, qty) {
        const p = products[key];
        if (!p) return;
        const existing = cart.get(key);
        if (existing) {
            existing.qty += qty;
        } else {
            cart.set(key, { key, name: p.name, price: p.price, qty });
        }
        showToast(`Scanned: ${p.name} x${qty}`);
        renderCart();

        const { items } = computeTotals();
        if (ENABLE_FAKE_BUG && !fakeBugTriggered && items === 2) {
            triggerFakeBug();
        }
    }

    function adjustQty(key, delta) {
        const line = cart.get(key);
        if (!line) return;
        line.qty += delta;
        if (line.qty <= 0) {
            cart.delete(key);
            showToast('Item removed');
        } else {
            showToast('Quantity updated');
        }
        renderCart();
    }

    function removeLine(key) {
        if (cart.has(key)) {
            cart.delete(key);
            showToast('Item removed');
            renderCart();
        }
    }

    function clearCart(resetPricing = false) {
        cart.clear();
        if (resetPricing) {
            resetTransactionPricing();
        }
        renderCart();
    }

    function triggerFakeBug() {
        fakeBugTriggered = true;
        bugOverlay.style.display = 'flex';
        bugOverlay.setAttribute('aria-hidden', 'false');
    }

    function showScreensaver() {
        if (screensaverActive) return;
        screensaverActive = true;
        screensaverOverlay.style.display = 'flex';
        screensaverOverlay.setAttribute('aria-hidden', 'false');
        screensaverMessage.style.display = 'none';
        screensaverVideo.loop = true;
        screensaverVideo.currentTime = 0;
        screensaverVideo.load();
        screensaverVideo.play().catch(() => {
            screensaverMessage.style.display = 'block';
        });
        window.clearInterval(screensaverKeepaliveTimer);
        screensaverKeepaliveTimer = window.setInterval(() => {
            if (!screensaverActive) return;
            if (screensaverVideo.ended) {
                screensaverVideo.currentTime = 0;
            }
            if (screensaverVideo.paused) {
                screensaverVideo.play().catch(() => {
                    screensaverMessage.style.display = 'block';
                });
            }
        }, 1000);
    }

    function hideScreensaver() {
        if (!screensaverActive) return;
        screensaverActive = false;
        screensaverOverlay.style.display = 'none';
        screensaverOverlay.setAttribute('aria-hidden', 'true');
        screensaverVideo.pause();
        screensaverVideo.currentTime = 0;
        window.clearInterval(screensaverKeepaliveTimer);
        screensaverKeepaliveTimer = null;
        screensaverMessage.style.display = 'none';
    }

    function scheduleScreensaver() {
        window.clearTimeout(screensaverTimer);
        screensaverTimer = window.setTimeout(showScreensaver, IDLE_TIMEOUT_MS);
    }

    function handleUserActivity(e) {
        const evtType = e && e.type ? e.type : '';
        const interactive = evtType === 'click' || evtType === 'touchstart' || evtType === 'mousedown' || evtType === 'keydown';
        if (screensaverActive) {
            if (!interactive) {
                return;
            }
            hideScreensaver();
        }
        scheduleScreensaver();
    }


    function payFlow(methodLabel) {
        const { total, items } = computeTotals();
        if (items === 0) {
            showToast('Scan something first');
            return;
        }

        openModal(
            `${methodLabel}`,
            `You are about to pay ${moneyAUD(total)} for ${items} item(s).`,
            'Confirm payment',
            async () => {
                closeModal();
                try {
                    await postReceipt(methodLabel);
                    showToast('Payment approved and receipt printed');
                    clearCart(true);
                } catch (err) {
                    showToast(`Print failed: ${err.message || err}`);
                }
            }
        );
    }

    // Wire up events
    const productButtons = document.querySelectorAll('.btn-product');

    productButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-key');
            addToCart(key, 1);
        });
    });


    payNowBtn.addEventListener('click', () => payFlow('Pay Now'));
    cardBtn.addEventListener('click', () => payFlow('Card Payment'));
    walletBtn.addEventListener('click', () => payFlow('Mobile Wallet'));

    cancelBtn.addEventListener('click', () => {
        if (cart.size === 0) {
            showToast('Nothing to cancel');
            return;
        }
        openModal('Cancel transaction', 'This will cancel the transaction and clear the cart.', 'Cancel transaction', () => {
            closeModal();
            clearCart(true);
            showToast('Transaction cancelled');
        });
    });

    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        handleKeyboardScannerKey(e);
        handleUserActivity(e);
        if (e.key === 'Escape') closeModal();
    });
    cameraSelect.addEventListener('change', () => startCamera(cameraSelect.value));

    const activityEvents = ['mousemove', 'mousedown', 'touchstart', 'wheel', 'click'];
    activityEvents.forEach(eventName => {
        document.addEventListener(eventName, handleUserActivity, { passive: true });
    });
    screensaverOverlay.addEventListener('click', handleUserActivity);
    screensaverOverlay.addEventListener('touchstart', handleUserActivity, { passive: true });
    screensaverVideo.addEventListener('ended', () => {
        // Defensive replay path for devices/browsers that ignore `loop` intermittently.
        screensaverVideo.currentTime = 0;
        screensaverVideo.play().catch(() => {
            screensaverMessage.style.display = 'block';
        });
    });
    screensaverVideo.addEventListener('error', () => {
        screensaverMessage.style.display = 'block';
    });

    // Initial state
    renderCart();
    connectPosEvents();
    startCamera('');
    screensaverVideo.load();
    scheduleScreensaver();
})();
</script>
</body>
</html>
